# Аутентификация и авторизация

Локальная аутентификация по email/паролю с JWT токенами. Двухфакторная аутентификация не используется. Интеграция с GitHub остаётся для воркфлоу fork/PR, но не для входа в систему.

## Контракт аутентификации

- Регистрация: email + пароль (валидируемый по политике сложности)
- Вход: email + пароль → выдача пары токенов
  - access_token (JWT, короткий TTL, например 15 минут)
  - refresh_token (строка/JWT, более длинный TTL, например 7 дней)
- Обновление access_token: по действующему refresh_token (ротация refresh при каждом обновлении)
- Выход: отзыв текущего refresh_token
- Восстановление пароля: запрос/reset токен + установка нового пароля

Пароли хешируются алгоритмом Argon2id (рекомендуется) или bcrypt (fallback). Секреты для подписи JWT хранятся в менеджере секретов.

## JWT требования

- Подпись: HS256 (симметричный ключ) или RS256 (асимметричные ключи)
- Обязательные клеймы: sub (user_id), exp, iat, jti, roles[]
- Проверка на сервере: подпись, exp, iat/nbf, допустимый clock skew (±60s)
- Стратегия истечения: access_token истекает быстро; для продления используется refresh_token
- Logout/отзыв: хранение хэша refresh_token на сервере и пометка отозванным/истёкшим

## Эндпоинты

- POST /auth/register — регистрация пользователя
- POST /auth/login — вход, выдаёт access_token (+ refresh_token)
- POST /auth/refresh — обновление пары токенов по refresh_token
- POST /auth/logout — отзыв текущего refresh_token
- POST /auth/request-password-reset — инициировать восстановление пароля
- POST /auth/reset-password — установить новый пароль по токену

Пример ответа /auth/login:

```json
{
  "access_token": "<jwt>",
  "refresh_token": "<opaque-or-jwt>",
  "token_type": "bearer",
  "expires_in": 900
}
```

Статусы ошибок: 400 (валидация), 401 (неверные креды/просроченный токен), 409 (email уже занят).

## Авторизация (RBAC)

- Роли: student, teacher, maintainer, admin
- Принципы:
  - Минимально необходимые привилегии
  - Проверка владельца ресурса (submission.owner == user.id)
  - Политики по времени (например, teacher может запросить regrade до дедлайна)

## Аудит и безопасность

- Логировать успешные/неуспешные входы (без хранения паролей/секретов)
- Трассировать операции изменения оценок и рубрик (кто/когда/что)
- Ограничивать TTL токенов и применять ротацию refresh_token
- При смене пароля — отзывать все активные refresh_token пользователя
