# Метрики качества и эксплуатации AI

## Цели

- Обеспечить наблюдаемость влияния AI на итоговые оценки
- Раннее обнаружение деградации (drift, рост латентности)
- Сравнимость моделей и провайдеров

## Категории метрик

| Категория | Метрика | Описание | Примечание |
|-----------|---------|----------|------------|
| Производительность | latency_p95_ms | Время отклика 95 перцентиль | Отдельно по типам задач |
| Стоимость | tokens_total | Суммарно токенов (prompt+completion) | Пер модель / период |
| Качество согласия | agreement_rate | Доля совпадений AI оценки с итоговой | С учётом tolerance |
| Дрифт | embedding_drift | Косинус расстояние распределений эмбеддингов | Аггрегация по неделям |
| Надёжность | failure_rate | Ошибки вызова / общее число | HTTP 5xx + timeouts |
| Редакции | feedback_revision_rate | Доля правок преподавателя на AI feedback | Высокое значение = шум |
| «Галлюцинации» | hallucination_flag_rate | Доля пометок преподавателя «некорректно» | Через UI флаг |

## Сбор

- Traces: атрибуты `ai.model`, `ai.task`, `ai.tokens_prompt`, `ai.tokens_completion`
- Метрики Prometheus: counter + histogram
- Логи: структурированные записи с correlation id submission / evaluation

## Alerts (пример)

| Правило | Условие | Действие |
|---------|---------|----------|
| Latency Degradation | latency_p95_ms > 3000 5m | Уведомление DevOps |
| Failure Spike | failure_rate > 0.05 10m | Пейджинг |
| Drift Suspicious | embedding_drift > 0.15 1d | Анализ выборки |
| Agreement Drop | agreement_rate < 0.7 1d | Ревью рубрики / модели |

## Интерпретация agreement_rate

`agreement_rate = совпадения / (совпадения + расхождения)`

Где совпадение — критерий, где |AI - финал| <= tolerance (напр. 0.05).

## Drift (эскиз расчёта)

1. Берём эмбеддинги контекста запросов за неделю N и N-1
2. Строим усреднённые распределения (centroid)
3. Считаем `1 - cosine_similarity(cN, cN-1)`
4. Сравниваем с порогом

## Лимиты хранения

| Артефакт | Retention | Причина |
|----------|-----------|---------|
| Raw model responses | 30d | Стоимость + приватность |
| Aggregated metrics | 400d | Тренды учебного года |
| Embedding samples | 90d | Drift анализ |

## Использование метрик в решениях

- Подбор провайдера (cost vs latency)
- Решение о перекалибровке весов рубрики
- Обнаружение необходимости fine-tune / инструкций

## Открытые вопросы

- Нужно ли хранение сырых промптов для аудита >30d? (компромисс приватности)
- Нужен ли контроль стабильности temperature параметра?
