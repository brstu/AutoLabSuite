# Маршруты (экраны) и пользовательские сценарии

Этот документ фиксирует ключевые маршруты веб‑приложения и сквозные сценарии для ролей: Админ, Преподаватель, Студент. Интеграция с GitHub используется для приёма/выдачи заданий (fork + PR), а ИИ — для анализа и генерации вопросов.

## Навигация и страницы

- Общие
  - /auth/login — локальный вход (email/пароль), опциональная привязка GitHub
  - /auth/register — регистрация (email/пароль)
  - /auth/forgot — запрос восстановления пароля
  - /auth/reset — сброс пароля по токену
  - /notifications — центр уведомлений
  - /profile — профиль пользователя, токены/интеграции
- Админ
  - /admin/users — пользователи: создание студента, преподавателя
  - /admin/groups — группы: CRUD, импорты
  - /admin/courses — курсы: обзор, владение, метаданные
  - /admin/permissions — роли и права (RBAC), аудит
- Преподаватель
  - /t/courses — мои курсы
  - /t/courses/:courseId — дашборд курса (группы, прогресс, дедлайны)
  - /t/courses/:courseId/collections — список коллекций (лабораторных наборов)
  - /t/collections/:collectionId — дашборд коллекции
  - /t/collections/:collectionId/labs/:labId/submissions — отправки, фильтры
  - /t/submissions/:submissionId — подробности проверки, AI артефакты
  - /t/rubrics — управление рубриками (черновик/публикация)
  - /t/questions/:submissionId — генерация и редактирование вопросов на защиту
  - /t/integrations/github — подключение/проверка вебхуков, шаблоны
  - /t/models — выбор и настройка AI моделей (внешние/KServe)
- Студент
  - /s/courses — мои курсы
  - /s/courses/:courseId/collections — список коллекций и лаб с дедлайнами
  - /s/courses/:courseId/results — результаты по лабам (сводная таблица)
  - /s/labs/:labId — требования, ссылка на «правильную» структуру (элемент коллекции)
  - /s/submissions — мои отправки
  - /s/submissions/:submissionId — результаты, фидбек, статус
  - /s/defense/:submissionId — подготовка к защите, вопросы от ИИ

## Сценарии

### 1. Создание курса и лабы (преподаватель)

1. /t/courses → «Создать курс»
2. Ввод названия, семестра; сохранение
3. /t/courses/:courseId/labs → «Добавить лабу»
4. Указание GitHub организации/репозитория или «Создать из шаблона»
5. Сохранение GitHub токена (scoped) и установка вебхука PR
6. Приложение создаёт минимально необходимую структуру в репозитории

### 2. Добавление группы к коллекции и уведомления

1. /t/collections/:collectionId → «Добавить группу» → выбор группы
2. Приложение отправляет уведомления студентам (email/GitHub issues/внутренние)
3. На странице лабы появляется список студентов и статусы «не начал/в процессе/сдано»

### 3. Сдача лабы студентом (fork + PR, элемент коллекции)

1. Студент открывает /s/labs/:labId → читает требования и видит ссылку на GitHub
2. Делает fork репозитория, выполняет работу
3. Создаёт Pull Request в основной репозиторий
4. Вебхук PR попадает в систему → создаётся Submission со ссылкой на PR
5. В /s/submissions/:id видно событие со ссылкой на PR и статус «В очереди»

### 4. Workflow «Проверка на директорию» и базовые проверки

1. Sandbox проверяет структуру (например, наличие директории/файла из WT-AC-2025)
2. Если базовые проверки пройдены → формируется prompt через скрипт .github/scripts/prepare_AI_prompt.py
3. Файлы и prompt передаются нескольким AI моделям (внешние и через KServe)
4. Результат сохраняется только для преподавателя в /t/submissions/:id (AI вкладка)

### 5. Публикация предварительной оценки и взаимодействие со студентом

1. Преподаватель просматривает результаты и AI обоснования
2. Нажимает «Опубликовать предварительную оценку» → студент видит превью
3. Студент выбирает: «Согласен» → статус «готов к защите», либо «Оспорить» → комментарий/доработка и новый PR/коммит

### 6. Генерация вопросов на защиту

1. Преподаватель открывает /t/questions/:submissionId
2. ИИ генерирует список вопросов по теме и решению студента; преподаватель может редактировать
3. Пакет вопросов сохраняется и доступен студенту на странице подготовки к защите

### 7. Просмотр результатов по курсу (студент)

1. Студент открывает /s/courses → выбирает дисциплину
2. На /s/courses/:courseId/results видит сводную таблицу по всем лабам курса:
   - Лаба, дедлайн, статус (не начато/в процессе/сдано), попытки (PR), текущая оценка/превью
3. Переходит в детали конкретной лабы (/s/labs/:labId) или конкретной отправки (/s/submissions/:submissionId)

## Ошибки и крайние случаи

- Отсутствует нужная директория/файл → «минимальные проверки не пройдены», подсказка, ссылка на пример
- PR из чужого форка без доступа → игнор/ошибка, журнал в интеграциях GitHub
- Токен GitHub просрочен → страница интеграций с рекомендацией переиздать
- Таймаут/ошибка AI → частичный результат, повторная попытка, fallback‑модель

## Примечания

- Студент задаёт вопросы преподавателю через комментарии в PR и/или встроенный Q&A в /s/submissions/:id
- Все действия логируются для аудита (кто/когда/что опубликовал, какие модели использовались)

## Подробные маршруты и действия (MVP)

Ниже — пошаговые маршруты и ключевые действия по ролям. Аутентификация — локальная (email/пароль), форк/PR студент делает вручную на GitHub.

### Админ

1. Вход: /auth/login → ввод email/пароля → успешный вход → редирект на /admin/users
1. Создать студента (штучно): /admin/users → «Создать пользователя» → форма (email, имя, роль: student, группа опц.) → Сохранить → возврат на /admin/users
1. Импорт студентов (CSV): /admin/users → «Импорт» → /admin/users/import → загрузка CSV (email, имя, группа) → предпросмотр → «Импортировать» → отчёт
1. Создать группу и добавить студентов: /admin/groups → «Создать группу» → ввод названия/курса → Сохранить → /admin/groups/:groupId → «Добавить студентов» → выбор из списка
1. Назначить роли преподавателей: /admin/users → поиск пользователя → «Изменить» → роль: teacher → Сохранить
1. Просмотр аудита: /admin/permissions → вкладка «Аудит» → фильтры по пользователю/дате/событию

### Преподаватель

1. Создать курс: /t/courses → «Создать курс» → ввести название и семестр → Сохранить → /t/courses/:courseId
1. Добавить лабу в курс: /t/courses/:courseId/labs → «Добавить лабу» → название, дедлайн, шаблон/репозиторий → Сохранить → /t/courses/:courseId/labs/:labId
1. Подключить группу и уведомить студентов: /t/courses/:courseId/labs/:labId → «Добавить группу» → выбрать группу → «Отправить уведомления»
1. Настроить GitHub вебхук (PR → Submission): /t/integrations/github → «Сгенерировать секрет/URL» → установить вебхук в GitHub → статус «Активен»
1. Смотреть отправки и детали проверки: /t/courses/:courseId/labs/:labId/submissions → фильтры/поиск → открыть /t/submissions/:submissionId
1. Публиковать предварительную оценку: /t/submissions/:submissionId → вкладка «AI (MVP)» → «Опубликовать предварительную оценку»
1. Запросить доработку: /t/submissions/:submissionId → «Запросить доработку» → комментарий → (опц.) шаблонный комментарий в PR
1. Управление рубриками: /t/rubrics → «Создать черновик» → задать критерии → «Опубликовать» (bump версии)

### Студент

1. Просмотр курсов и результатов: /s/courses → выбрать курс → /s/courses/:courseId/results (сводная таблица «лабы/статус/оценка»)
1. Ознакомиться с лабой и сдать работу: /s/courses/:courseId/labs → выбрать лабу → /s/labs/:labId (требования и ссылки) → на GitHub выполнить форк и создать PR вручную
1. Отслеживать статус отправки: /s/submissions → список попыток → /s/submissions/:submissionId (стадии: «Проверка структуры → Подготовка prompt → Вызов ИИ …»)
1. Взаимодействие по оценке: после публикации преподавателем → «Согласен» или «Оспорить» (комментарий/доработка)
1. Подготовка к защите: /s/defense/:submissionId → вопросы от ИИ и материалы для подготовки
