name: Deploy Kubeflow

on:
  push:
    branches: [ main ]
    paths:
      - 'infra/kubeflow/**'
      - '.github/workflows/deploy-kubeflow.yml'

jobs:
  validate:
    name: Validate Kubeflow manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kustomize
        run: |
          curl -sSL https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize/v5.0.1/kustomize_v5.0.1_linux_amd64.tar.gz -o /tmp/kustomize.tar.gz
          tar -xzf /tmp/kustomize.tar.gz -C /usr/local/bin kustomize

      - name: Kustomize build if present
        run: |
          if [ -f infra/kubeflow/kustomization.yaml ]; then kustomize build infra/kubeflow > /tmp/kf-manifest.yaml; else echo "No kustomization found, skipping"; fi

      - name: Validate manifests with kubeval (best-effort)
        run: |
          if [ -f /tmp/kf-manifest.yaml ]; then curl -sSL https://github.com/instrumenta/kubeval/releases/download/0.16.0/kubeval-linux-amd64.tar.gz -o /tmp/kubeval.tar.gz && tar -xzf /tmp/kubeval.tar.gz -C /usr/local/bin kubeval && kubeval /tmp/kf-manifest.yaml || true; else echo "No manifests to validate"; fi

  deploy:
    name: Deploy Kubeflow (requires KUBE_CONFIG_DATA secret)
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ secrets.KUBE_CONFIG_DATA != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubeconfig
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBE_CONFIG_DATA" | base64 -d > $HOME/.kube/config

      - name: Apply Kubeflow manifests (kustomize or manifests/)
        run: |
          if [ -f infra/kubeflow/kustomization.yaml ]; then kustomize build infra/kubeflow | kubectl apply -f -; elif [ -d infra/kubeflow/manifests ]; then kubectl apply -f infra/kubeflow/manifests; else echo "No Kubeflow manifests found under infra/kubeflow/"; fi

      - name: Wait for kubeflow namespace deployments (best-effort)
        run: |
          kubectl wait --for=condition=available --timeout=600s deployment -n kubeflow --all || true
